<html>

    <head>

        <meta charset="UTF-8">

        <title>ç½‘é¡µæ ‡é¢˜</title>

<!--         <link rel="stylesheet" type="text/css" href="css/style.css"> -->

        <script src="./jquery-3.5.1.min.js"></script>
        <style type="text/css"> 
            h1{color:red} 
            p{color:blue} 

            .box{
                width: 1300px;

            }
            .contacts{
                width: 100px;
                height: 438px;
                border: 1px solid;
                float:left;
                overflow-y:auto;
            }
            .contact{
                width:100%;
                height:25px;
                border-bottom: 1px solid;
            }
            .contact img{
                width:20px;
            }
            .chat{
                width:520px;
            }
            #msg_box{
                width:400px;
                height:400px;
                border: 1px solid black;
                overflow-y:auto;
                float:left;
            }
            .send_btn {
                background-color: #4CAF50; /* Green */
                border: none;
                color: white;
                text-align: center;
                text-decoration: none;
                /*display: inline-block;*/
                font-size: 16px;
                width: 50px;
                height:36px;
            }
            .send_text{
                width:200px;
            }
            .msg_content{
                width:100%;
                height: 25px;
                border-bottom:1px solid #F7F7F7;
            }
            input{
                height:30px;line-height:30px;vertical-align:middle;
            }
        </style> 

    </head>

    <body>

        <div class='box'>
            <!--å±•ç¤ºæ¡†-->
            <div class='contacts'>
                <div id='contacts_box'>
                    <div class="contact">
                        list
                    </div>
                    
                </div>
            </div>
            <div class='chat'>
                <div id="msg_box">
                    <!-- <div class="msg_content" >111   <div  style="float: right;">  2222</div></div> -->
                </div>
                <!--å‘é€æ¡†-->
                <div>
                    <input type="text" name="" class='send_text'>
                    <input type="file" id='file_btn' name="pic" onchange="upload(this)">
                    <button type="button"  class='send_btn' id='send_btn'>send</button>
                </div>
                <!-- <div>
                    <button type="button"  class='send_btn' onclick="javascript:WebSocketTest()"></button>
                </div> -->
            </div>
        </div>
        <div class="sys"></div>
        <div class="sys_1">
            <input type="text" name="new_add" id="new_add" class='send_text'>
            <button type="button"  class='send_btn' id='add_btn'>æ–°å¢</button>
        </div>

    </body>
    <script type="text/javascript">
            // ç”¨äºå­˜å‚¨ç”¨æˆ· id->ç”¨æˆ·ä¿¡æ¯
            var userArr = []
            // å¯¹åº”æŸä¸ªç”¨æˆ·èŠå¤©çš„å½“å‰é¡µ
            var current_page = 1
            var total_page = 1
            // å½“å‰é¡µä¼šè¯ä¿¡æ¯
            var conv_info_global = new Object()
            conv_info_global.conv_id = null
            // å¾…ä¸Šä¼ çš„æ–‡ä»¶
            var upObject = [];

            $(document).ready(function(){
                // è°ƒç”¨æ–¹æ³•
                //alert(GetQueryString("loginId"));

                var userNickname = GetQueryString("userNickname")
                var touserNickname = GetQueryString("touserNickname")


                if (!userNickname&&!touserNickname){
                    console.log("ç”¨æˆ·idä¸æ­£ç¡®");
                    return;
                }

                // t = setInterval("showAuto()", 1000);

                // ç™»å½•api
                var res = requestData("http://127.0.0.1/api/user/login?nickname="+userNickname+"&pwd=123456");
                var loginData = JSON.parse( res );
                // console.log(loginData)
                // console.log(loginData.code)
                // å®ä¾‹åŒ–ç”¨æˆ·ä¿¡æ¯
                if ( loginData.code != 0 ){
                    console.log('ç™»å½•å¤±è´¥');
                    console.log(loginData);
                    return;
                }else{
                    //console.log(loginData)

                    var User = new Object()
                    User.nickname = loginData.data.nickname
                    User.avatar = loginData.data.avatar
                    User.userid = loginData.data.id
                    // ç»™ç”¨æˆ·ç”Ÿæˆä¸€ä¸ªéšæœºçš„å­—ç¬¦ä¸²ä½œä¸ºè®¾å¤‡id
                    User.deviceid = randomString(16)

                    // ç”¨ä¸€ä¸ªæ•°ç»„å˜é‡å……å½“cookie
                    var tempinfo = []

                    tempinfo['nickname'] = User.nickname;
                    tempinfo['avatar'] = User.avatar;
                    console.log(tempinfo)
                    userArr["user"+User.userid.toString()] = tempinfo //JSON.stringify(tempinfo);
                    console.log(userArr)


                    // è·å–å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯api
                    var res = requestData("http://127.0.0.1/api/user/userInfo?nickname="+touserNickname,null,'GET');
                    var touserData = JSON.parse( res );
                    if( touserData.code !=0 ){
                        console.log('å¯¹æ–¹ä¿¡æ¯è·å–å¤±è´¥');
                        console.log(touserData);
                        return;
                    }
                    // console.log(touserData)
                    var toUser = new Object()
                    toUser.nickname = loginData.data.nickname
                    toUser.avatar = loginData.data.avatar
                    toUser.userid = loginData.data.id

                }

                // è·å–ä¼šè¯åˆ—è¡¨
                var chatList = requestData("http://127.0.0.1/api/im/getconvlist?client_id="+loginData.data.id,null,'GET');
                var chatList = JSON.parse( chatList );
                console.log("ChatList");
                console.log(chatList);
                if( chatList.code == 0 ){
                    var charList = chatList.data.data 
                    $.each(charList, function(key, val) {
                        if( val.conv_type == 1 ){ //ç§èŠ
                            if( val.conv_extend.conv_name ){

                            }
                        }
                        // alert("val.conv_extend.conv_name."+User.nickname)
                        // var _conv_name = eval("val.conv_extend.conv_name."+User.nickname)
                        // var _conv_name = "val.conv_extend.conv_name."+User.nickname;
                        // eval(_conv_name
                        console.log("~~~~~~~~~~~1~~~~~~~~~")
                        var conv_name = JSON.parse( JSON.stringify(val.conv_extend.conv_name)) // å…ˆè½¬å­—ç¬¦ä¸²å†æŠ“æ•°ç»„
                        var conv_avatar = JSON.parse( JSON.stringify(val.conv_extend.conv_avatar)) // å…ˆè½¬å­—ç¬¦ä¸²å†æŠ“æ•°ç»„
                        console.log(conv_name)
                        console.log("~~~~~~~~~~~2~~~~~~~~~")
                        $("#contacts_box").append("<div class='contact' data-conv_id='"+val.conv_id+"' onclick=javascript:showLab('"+val.conv_id+"','"+conv_name[User.nickname]+"')><img src='"+conv_avatar[User.nickname]+"'/>"+conv_name[User.nickname]+"</div>");

                        // è·å–ä¼šè¯æˆå‘˜
                        var memberList = requestData("http://127.0.0.1/api/im/members?conv_id="+val.conv_id,null,'GET');
                        var memberList = JSON.parse( memberList );
                        if( memberList.code == 0 ){
                            $.each(memberList.data, function(key, val) {  
                                // è·å–å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯api
                                var res = requestData("http://127.0.0.1/api/user/userInfo?id="+val,null,'GET');
                                var touserData = JSON.parse( res );
                                console.log("----")
                                console.log(touserData);
                                if( touserData.code == 0 ){
                                    var tempinfo = []
                                    var temp = touserData.data
                                    console.log(temp)
                                    tempinfo['nickname'] = temp.nickname;
                                    tempinfo['avatar'] = temp.avatar;
                                    userArr["user"+temp.id] = tempinfo;
                                }
                            })
                        }
                        // è¿™é‡Œä¸´æ—¶æŠŠconv_idæ‹¿å‡ºæ¥
                        if( key == 0 ){
                            $(".sys").html("<div id='conv_id' style=''>"+val.conv_id+"</div>")
                        }

                    });  
                }

                // æ‹¼è£…socketä¿¡æ¯
                var login_Data = new Object()
                login_Data.type = 'login';
                login_Data.data = {
                    'client_id':User.userid,
                    'device_id':User.deviceid,
                    'app_id':'666666',
                    'ext':{
                        'nickname':User.nickname
                    }
                }; 

                // start
                if ("WebSocket" in window){
                    var ws = new WebSocket("ws://127.0.0.1:8282");
                    ws.onopen = function(){
                        // Web Socket å·²è¿æ¥ä¸Šï¼Œä½¿ç”¨ send() æ–¹æ³•å‘é€æ•°æ®
                        // ws.send("å‘é€æ•°æ®");
                        // alert("æ•°æ®å‘é€ä¸­...");
                        ws.send(JSON.stringify( login_Data ));
                    };
                    
                    ws.onmessage = function (evt){ 
                        var received_msg = evt.data;
                        console.log("æ¥å—å‚æ•°ï¼š");
                        console.log(received_msg);
                        var res = JSON.parse( received_msg );
                        switch(res.type) {
                            case "login.success" : 
                                console.log("ç™»å½•æˆåŠŸ");
                                $("#msg_box").append("<div class='msg_content'>"+ User.nickname + " ç™»å…¥äº†èŠå¤© </div>");
                            break;
                            case "msg.new" :
                                console.log("æ–°æ¶ˆæ¯");
                                if( res.data.type == -2 ){
                                    $("#msg_box").append("<div class='msg_content' style='height'>"+ userArr['user'+res.data.from_client]['nickname']+" : <img src="+res.data.url+" style='width:100px'><div  style='float: right;'>  "+ format(res.data.ctime) +"</div></div>");
                                }else{
                                    $("#msg_box").append("<div class='msg_content'>"+ userArr['user'+res.data.from_client]['nickname']+" : " + res.data.text + "<div  style='float: right;'>  "+ format(res.data.ctime) +"</div></div>");
                                }
                                var showContent = $("#msg_box");
                                showContent[0].scrollTop = showContent[0].scrollHeight;      
                            break;
                            case "ping" :
                            break;
                            default:
                                console.log("æœªè§£æçš„æ¶ˆæ¯");
                            break;
                        } 
                    };
                }else{
                    alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebSocket!");
                }

                // send åŒæ—¶ç»‘å®šclick å’Œ keydown
                $(document).keyup(function(event){
                    if(event.keyCode ==13){
                        $("#send_btn").click()
                    }
                });

                $("#send_btn").click( function(){
                    var msg_test = $(".send_text").val()
                    // alert('start')
                    if( $("#file_btn").val() ){

                        var files = $("#file_btn")[0].files;
                        //alert(files.length)
                        //alert(files[0])
                        var formData = new FormData();
                        for(var i = 0;i<files.length;i++){
                            //alert(files[i])
                            formData.append("file", files[i]);
                        }
                        formData.append("name", '11');

                        // var form = new FormData();
                        // form.append("file", $("#file_btn").files[0]);
                        // alert(formData)
                        $.ajax({
                            headers: {
                                "app-id":"666666"
                            },
                            //è¯·æ±‚æ–¹å¼
                            type : 'POST',
                            //è¯·æ±‚çš„åª’ä½“ç±»å‹
                            contentType: false ,
                            enctype: 'multipart/form-data',
                            processData: false,
                            //è¯·æ±‚åœ°å€
                            async : false,
                            url : "http://127.0.0.1/im/file/upload",
                            //æ•°æ®ï¼Œjsonå­—ç¬¦ä¸²
                            data : formData,
                            //è¯·æ±‚æˆåŠŸ
                            success : function(result) {
                                var result = JSON.parse( result );
                                if( result.code == 0 ){
                                    upObject[0] = result.data.file_url
                                }
                            },
                            //è¯·æ±‚å¤±è´¥ï¼ŒåŒ…å«å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                            error : function(e){
                                console.log(e.status);
                                console.log(e.responseText);
                            }
                        });
                        // alert('3')
                        // var chat_res = requestData("http://127.0.0.1/im/file/upload",upObject,'POST',true);
                        // alert('4')
                        //alert(chat_res)
                        // return;
                        msg_test = '*'
                    }else{
                        if ( msg_test == '' ){
                            $("#msg_box").append("<div class='msg_content'>æ— æ•ˆç©ºæ¶ˆæ¯</div>");
                        }
                    }
                    var msg_send_data = new Object()
                    if( upObject[0] ){
                        msg_send_data = {
                            "from_client" : User.userid,
                            "type" : -2,
                            "text" : msg_test,
                            "url" : upObject[0]
                        }
                    }else{
                        msg_send_data = {
                            "from_client" : User.userid,
                            "type" : -1,
                            "text" : msg_test
                        }
                    }

                    // console.log(JSON.stringify(msg_send_data))
                    var chat_res = requestData("http://127.0.0.1/im/conversations/"+$("#conv_id").html()+"/message",msg_send_data,'POST');
                    var chat_res = JSON.parse( chat_res );
                    if ( chat_res.code == 0 ) {
                        console.log("å‘é€æ¶ˆæ¯")
                        console.log(chat_res)
                        console.log("å‘é€æ¶ˆæ¯end")
                        $(".send_text").val("")
                    }
                    //http://127.0.0.1/im/conversations/cd7fc5304f56f52488d5246b0ebbdbfb/message
                    //var chat_res = JSON.parse( chat_res );
                })


                //æ•°ç»„è½¬jsonå­—ç¬¦ä¸²
                var arr = [1,2,3, { a : 1 } ];
                //console.log(JSON.stringify( arr ));
                //jsonå­—ç¬¦ä¸²è½¬æ•°ç»„
                var jsonStr = '[1,2,3,{"a":1}]';
                //console.log(JSON.parse( jsonStr ));

                // æ»‘åˆ°é¡¶éƒ¨æ£€æµ‹åˆ†é¡µ
                $("#msg_box").scroll(function() {
                    if ($("#msg_box").scrollTop()<=0 && conv_info_global.conv_id ){
                        console.log(current_page)
                        if( total_page >= current_page+1 ){
                            getMsgList(conv_info_global.conv_id,conv_info_global.conv_name,current_page+1)
                        }
                    }
                })
                // æ–°å¢ç”¨æˆ·
                $("#add_btn").click( function(){
                    var new_usernickname = $("#new_add").val()

                    // alert(User.nickname)
                    var add_res = requestData("http://127.0.0.1/api/im/createconv?nickname="+User.nickname+"&to_nickname="+new_usernickname,[],'POST');
                    var add_res = JSON.parse( add_res );
                    console.log("111111111111111add_res")
                    console.log(add_res)
                    console.log("111111111111111add_res")
                    // alert(new_user_id)
                })
            })


            function showAuto(){
                var now = new Date();
                $("#msg_box").append("<div class='msg_content'>"+now.getTime()+"</div>"); 
                var div = document.getElementById('msg_box');
                div.scrollTop = div.scrollHeight;
            }

            // socketé“¾æ¥
            function WebSocketTest()
            {
                if ("WebSocket" in window){
                    alert("æ‚¨çš„æµè§ˆå™¨æ”¯æŒ WebSocket!");

                    // æ‰“å¼€ä¸€ä¸ª websocket


                    ws.onopen = function(){
                        // Web Socket å·²è¿æ¥ä¸Šï¼Œä½¿ç”¨ send() æ–¹æ³•å‘é€æ•°æ®
                        //ws.send("å‘é€æ•°æ®");
                        //alert("æ•°æ®å‘é€ä¸­...");
                    };

                    ws.send = function(){
                        // Web Socket å·²è¿æ¥ä¸Šï¼Œä½¿ç”¨ send() æ–¹æ³•å‘é€æ•°æ®
                        ws.send("å‘é€æ•°æ®");
                        alert("æ•°æ®å‘é€ä¸­...");
                    };

                    ws.onmessage = function (evt){ 
                        var received_msg = evt.data;
                        alert("æ•°æ®å·²æ¥æ”¶...");
                    };

                    ws.onclose = function(){ 
                        // å…³é—­ websocket
                        alert("è¿æ¥å·²å…³é—­..."); 
                    };
                }else
                    {
                    // æµè§ˆå™¨ä¸æ”¯æŒ WebSocket
                    alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebSocket!");
                }
            }

            function upload(obj){
                var files = obj.files ;
                var formData = new FormData();
                for(var i = 0;i<files.length;i++){
                    //alert(files[i])
                    formData.append("file", files[i]);
                }
                upObject = formData
                //alert(formData)
                // $.ajax({
                //     url: "1.php",
                //     type: "POST",
                //     data:formData,
                //     cache:false,         //ä¸è®¾ç½®ç¼“å­˜
                //     processData: false,  // ä¸å¤„ç†æ•°æ®
                //     contentType: false   // ä¸è®¾ç½®å†…å®¹ç±»å‹
                // });
            }
            // ç‚¹å‡»è”ç³»äººåˆ‡æ¢æ–‡å­—æ¡†
            function showLab(conv_id,conv_name){
                $('#msg_box').html('');
                $("#msg_box").append("<div class='msg_content'>å’Œ"+conv_name+"å¼€å§‹äº†æ–°çš„èŠå¤©</div>");
                conv_info_global.conv_id = conv_id
                conv_info_global.conv_name = conv_name

                $(".sys").html("<div id='conv_id' style=''>"+conv_id+"</div>")
                getMsgList(conv_id,conv_name,1) 
            }

            // åŠ è½½
            function getMsgList(conv_id,conv_name,page=1){
                // åŠ è½½å†å²èŠå¤©
                var chatList = requestData("http://127.0.0.1/api/im/getChatMsgs?conv_id="+conv_id+"&page="+page+"&size=20",[],'GET');
                var chatList = JSON.parse( chatList );
                var chatList = chatList.data;
                if( chatList.total>0 ){
                    $.each(chatList.data, function(key, val) { 
                        console.log('user'+val.client_id)
                        $("#msg_box").prepend("<div class='msg_content'>"+ userArr['user'+val.client_id]['nickname']+" : " + val.text + "<div  style='float: right;'>  "+ format(val.ctime) +"</div></div>");   
                    })
                   var showContent = $("#msg_box");
                   showContent[0].scrollTop = showContent[0].scrollHeight;
                }
                current_page = page
                total_page = chatList.last_page
            }





            /***  tool function ğŸ”½ ***/
            // è·å–getå‚æ•°
            function GetQueryString(name)
            {
                 var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                 var r = window.location.search.substr(1).match(reg);
                 if(r!=null)return  unescape(r[2]); return null;
            }
            // è¯·æ±‚
            function requestData(url,data = null,requestType = 'POST',isFile = false){
                var ajaxData = null;
                $.ajax({
                    headers: {
                        "app-id":"666666"
                    },
                    //è¯·æ±‚æ–¹å¼
                    type : requestType,
                    //è¯·æ±‚çš„åª’ä½“ç±»å‹
                    contentType: isFile ? false : "application/json;charset=UTF-8",
                    //è¯·æ±‚åœ°å€
                    async : false,
                    url : url,
                    //æ•°æ®ï¼Œjsonå­—ç¬¦ä¸²
                    data :  isFile ? data : JSON.stringify(data),
                    //è¯·æ±‚æˆåŠŸ
                    success : function(result) {
                         //console.log(result);
                         ajaxData = result;
                    },
                    //è¯·æ±‚å¤±è´¥ï¼ŒåŒ…å«å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    error : function(e){
                        console.log(e.status);
                        console.log(e.responseText);
                    }
                });
                return ajaxData;
            }


            // éšæœºå­—ç¬¦ä¸²
            function randomString(len) {
            ã€€ã€€len = len || 32;
            ã€€ã€€var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****é»˜è®¤å»æ‰äº†å®¹æ˜“æ··æ·†çš„å­—ç¬¦oOLl,9gq,Vv,Uu,I1****/
            ã€€ã€€var maxPos = $chars.length;
            ã€€ã€€var pwd = '';
            ã€€ã€€for (i = 0; i < len; i++) {
            ã€€ã€€ã€€ã€€pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
            ã€€ã€€}
            ã€€ã€€return pwd;
            }
            // æ—¶é—´æˆ³è½¬æ—¥æœŸæ ¼å¼
            function add0(m){return m<10?'0'+m:m }
            function format(shijianchuo)
            {
                //shijianchuoæ˜¯æ•´æ•°ï¼Œå¦åˆ™è¦parseIntè½¬æ¢
                var time = new Date(shijianchuo);
                var y = time.getFullYear();
                var m = time.getMonth()+1;
                var d = time.getDate();
                var h = time.getHours();
                var mm = time.getMinutes();
                var s = time.getSeconds();
                return add0(h)+':'+add0(mm)+':'+add0(s);
                // return y+'-'+add0(m)+'-'+add0(d)+' '+add0(h)+':'+add0(mm)+':'+add0(s);
            }
    </script>
</html>